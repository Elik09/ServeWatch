{% extends "base.html" %}
{% block cssImports %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.css" />
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap4.min.css" />
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.7/css/responsive.bootstrap4.min.css" />
<link rel="stylesheet" href="{{url_for('static', filename = 'css/account.css')}}">
{% endblock %}
{% block main %}
{% if current_user.can(permissions.EDITACCOUNT)%}
<div class="cover" id="modalCover">
    <div class="user--modal">
        <div class="modal--header">
            <span>EDIT USER DETAILS</span>
        </div>
        <div class="modal--body">
            <span class="error--message" id="modalNotice"></span>
            <form action="#" class="edit--form" id="userEditForm">
    
                <div class="form--element">
                    <label for="username">Username</label>
                    <input type="text" id="username">
                    <span class="error" id="usernameError"></span>
                </div>
                <div class="form--element ">
                    <label for="email">Email</label>
                    <input type="email" id="email">
                    <span class="error" id="emailError"></span>
                </div>
                <div class="form--element">
                    <label for="passwordEdit1">Password</label>
                    <input type="password" id="passwordEdit">
                    <span class="error" id="passwordEditError"></span>
                </div>
                <div class="form--element">
                    <label for="passwordEdit2">Confirm Password</label>
                    <input type="password" id="passwordEditConf">
                    <span class="error" id="passwordConfError"></span>
                </div>
    
                <div class="form--element">
                    <label for="ipAddress">Ip Address</label>
                    <input type="text" id="ipAddress">
                    <span class="error" id="ipError"></span>
                    <ip></ip>
                </div>
                <div class="form--element">
                    <label for="role">Role</label>
                    <select name="role" id="role">
                        <option value="admin">admin</option>
                        <option value="viewer">viewer</option>
                    </select>
                </div>
                <div class="form--element">
                    <label for="status">Status</label>
                    <select name="status" id="status">
                        <option value="active">active</option>
                        <option value="suspended">suspended</option>
                    </select>
                </div>
                <div class="form--element">
                    <input type="submit" value="Edit User Details" id="submit--userDetails">
                </div>
            </form>
        </div>
        <div class="modal--footer">
    
        </div>
    </div>

    <i class='bx bx-x close--cover' id="closeCover"></i>
</div>
{% endif %}


<div class="grid admin--main">
    <div class="tabs container">
        <input type="radio" name="tabs" id="tabone" checked="checked">
        <label for="tabone">User Accounts</label>
        <div class="tab">
            <div class="gv">
                <table id="logTable" class="table table-striped table-bordered grid--table" style="width:100%">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Date Created</th>
                            <th>Last Seen</th>
                            <th>Ip Address</th>
        
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                                <tr class="table--row" id="tableRow">
                                    <td>{{user.username}}</td>
                                    <td>{{user.email}}</td>
                                    <td>{{ user.role.name}}</td>
                                    <td>{{ user.status}}</td>
                                    <td>{{ user.created_at}}</td>
                                    <td>{{user.last_login}}</td>
                                    <td>{{user.ip}}</td>
                                </tr>
                            {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Date Created</th>
                            <th>Last Seen</th>
                            <th>Ip Address</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <input type="radio" name="tabs" id="tabtwo">
        <label for="tabtwo">Logs</label>
        <div class="tab">
                <div class="gv">
                    <table id="logTable" class="table table-striped table-bordered grid--table" style="width:100%">
                        <thead>
                            <tr>
                                <th>Log Id</th>
                                <th>User</th>
                                <th>Machine</th>
                                <th>Action</th>
                                <th>File Path</th>
                                <th>Date Of Action</th>
                                <th>Date Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for post in posts %}
                                <tr>
                                    <td>{{post.id}}</td>
                                    <td>{{post.user}}</td>
                                    <td>{{ post.machine}}</td>
                                    <td>{{ post.action}}</td>
                                    <td>{{ post.file_path}}</td>
                                    <td>{{post.modified}}</td>
                                    <td>{{post.date_posted}}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th>Log Id</th>
                                <th>User</th>
                                <th>Machine</th>
                                <th>Action</th>
                                <th>File Path</th>
                                <th>Date Of Action</th>
                                <th>Date Created</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
        </div>
      </div>
</div>

{% endblock %}
{% block scripts %}
<script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script type="text/javascript" src=" https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap5.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.19.1/dist/bootstrap-table.min.js"></script>
<script src="{{ url_for('static', filename = '/js/account.js')}}"></script>
<script src="{{ url_for('static', filename = '/js/admin.js')}}"></script>

{% if current_user.is_authenticated and current_user.is_admin() %}
<script>
// user edit 
const url = "{{ url_for('main.edit_user', _external = True)}}"
const dataPayload = {};
const userEditObj = {

    "modalPush":function(modalData){

        // populate the form fields with modalData

        usernameInput.value = modalData['username']
        emailInput.value = modalData['email']
        roleInput.value = modalData['role']
        statusInput.value = modalData['status']
        ipInput.value = modalData['ip']

        // display the modal fields
        modalCover.classList.add('show--cover')
    
    },
    "modalPop": function(){
        modalCover.classList.remove('show--cover')
    },
    "postRequest": function (postData) {
        fetch(url, {

            method :"POST",
            headers:{
                "Content-Type":"application/json",
            },
            body:JSON.stringify(postData)
        }).then(data.json())
        .then(data=>{

            console.log(data)
        }) 
    }
}
tableRows.forEach(row => {

    row.addEventListener('click', ()=>{
        let columns = row.children;
        // Payload object will be created once the click event occurs

        dataPayload.oldusername =columns[0].innerText,
        dataPayload.username = columns[0].innerText,
        dataPayload.email = columns[1].innerText,
        dataPayload.role = columns[2].innerText,
        dataPayload.status = columns[3].innerText,
        dataPayload.ip = columns[6].innerText

        // call the  display modal function with the given data
        userEditObj.modalPush(dataPayload);
        
    })
});

// add a change event lister to the password and  the username elements

usernameInput.addEventListener('change', ()=>{

    if(usernameInput.value !==dataPayload.username){

        dataPayload.username = usernameInput.value
    }
    
})

passwordInput.addEventListener('change', ()=>{

    if(passwordInput.value === ""){

        submitUserBtn.disabled = false;
    }

    if (passwordInput.value !== passwordConfInput.value) {

        passwordConfInput.classList.add('error--outline')
        passwordConfInput.nextElementSibling.innerText = "password don't match";
    // disable the submit btn
        submitUserBtn.disabled = true;
    }

    else {
        passwordConfInput.classList.remove('error--outline')
        passwordConfInput.nextElementSibling.innerText = "";
    // disable the submit btn
        submitUserBtn.disabled = false;
    }
})

passwordConfInput.addEventListener('change', ()=>{
    if(passwordConfInput.value === passwordInput.value){
        passwordConfInput.classList.remove('error--outline')
        passwordConfInput.nextElementSibling.innerText = "";
        submitUserBtn.disabled = false;

        dataPayload.password = passwordConfInput.value;

    }
})
closeCover.addEventListener('click', userEditObj.modalPop)
userEditForm.addEventListener('submit', event=>{

    // prevent the form from submitting
    event.preventDefault()
    // perform an ajax call
    userEditObj.postRequest(dataPayload);
})

roleInput.addEventListener('change', ()=>{

    dataPayload.role = roleInput.value
})
statusInput.addEventListener('change', ()=>{

    dataPayload.status = statusInput.value
})
</script>
{% endif %}
{% endblock %}